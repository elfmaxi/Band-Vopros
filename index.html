<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Band Vopros — Alpha</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #111;
        color: #eee;
        margin: 20px;
    }
    h1 {
        font-size: 28px;
        margin-bottom: 5px;
    }
    h2 { margin-top: 40px; }
    .alpha {
        font-size: 14px;
        color: #ff4444;
        margin-bottom: 20px;
    }
    .question-box, .answer-box {
        background: #1a1a1a;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 12px;
    }
    button {
        background: #333;
        border: 1px solid #555;
        color: #fff;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        margin-right: 5px;
    }
    button:hover { background: #444; }
    input, textarea {
        width: 100%;
        padding: 8px;
        background: #222;
        border: 1px solid #444;
        color: #fff;
        border-radius: 6px;
        margin-top: 5px;
        margin-bottom: 10px;
    }
    .answers {
        margin-top: 10px;
        padding-left: 15px;
    }
    .like-btn.liked {
        color: #ff4444;
    }
</style>
</head>
<body>

<h1>Band Vopros</h1>
<div class="alpha">Alpha</div>

<h2>Задать вопрос</h2>
<textarea id="questionInput" placeholder="Ваш вопрос..."></textarea>
<button onclick="postQuestion()">Отправить</button>

<h2>Все вопросы</h2>
<div id="questions"></div>

<script>
// ======================
// НАСТРОЙКА
// ======================
const API = "https://local3000";

// ======================
// ЗАЩИТА ОТ XSS
// ======================
function escapeHTML(str) {
    return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
}

// ======================
// ГЕНЕРАЦИЯ userId
// ======================
let userId = localStorage.getItem("bv_user_id");
if (!userId) {
    userId = "u_" + Math.random().toString(36).slice(2);
    localStorage.setItem("bv_user_id", userId);
}

// ======================
// Загрузка списка вопросов
// ======================
async function loadQuestions() {
    const res = await fetch(`${API}/questions?userId=${encodeURIComponent(userId)}`);
    const data = await res.json();
    if (!data.ok) return alert("Ошибка загрузки");

    const box = document.getElementById("questions");
    box.innerHTML = "";

    data.questions.forEach(q => {
        const qBox = document.createElement("div");
        qBox.className = "question-box";

        qBox.innerHTML = `
            <div><b>${escapeHTML(q.text)}</b></div>
            <div style="margin-top:5px;">
                <button class="like-btn ${q.likedByMe ? "liked" : ""}" onclick="toggleLike('${q.id}')">❤ ${q.likes}</button>
                <button onclick="showAnswerBox('${q.id}')">Ответить</button>
            </div>

            <div id="answerBox_${q.id}" style="display:none; margin-top:10px;">
                <textarea id="answerInput_${q.id}" placeholder="Ваш ответ..."></textarea>
                <button onclick="postAnswer('${q.id}')">Отправить ответ</button>
            </div>

            <div class="answers">
                ${q.answers.map(a => `
                    <div class="answer-box">${escapeHTML(a.text)}</div>
                `).join("")}
            </div>
        `;

        box.appendChild(qBox);
    });
}

// ======================
// Отправка вопроса
// ======================
async function postQuestion() {
    const text = document.getElementById("questionInput").value.trim();
    if (!text) return alert("Введите текст");

    const res = await fetch(`${API}/questions`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
    });

    const data = await res.json();
    if (!data.ok) return alert("Ошибка");

    document.getElementById("questionInput").value = "";
    loadQuestions();
}

// ======================
// Лайк / анлайк
// ======================
async function toggleLike(id) {
    const res = await fetch(`${API}/questions/${id}/toggle-like`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId })
    });

    const data = await res.json();
    if (!data.ok) return alert("Ошибка лайка");

    loadQuestions();
}

// ======================
// Показать окно ответа
// ======================
function showAnswerBox(id) {
    const box = document.getElementById("answerBox_" + id);
    box.style.display = box.style.display === "none" ? "block" : "none";
}

// ======================
// Отправка ответа
// ======================
async function postAnswer(qid) {
    const input = document.getElementById(`answerInput_${qid}`);
    const text = input.value.trim();
    if (!text) return alert("Введите ответ");

    const res = await fetch(`${API}/questions/${qid}/answers`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
    });

    const data = await res.json();
    if (!data.ok) return alert("Ошибка");

    input.value = "";
    loadQuestions();
}

// загрузить при старте
loadQuestions();
</script>
</body>
</html>
